UPDATE items i
JOIN (
    SELECT 
        i.id AS item_id,
        (COALESCE(rh.total_received, 0) - COALESCE(sh.total_supplied, 0)) AS updated_stock_quantity
    FROM 
        items i
    LEFT JOIN 
        (
            -- Get total received quantity per item and site
            SELECT 
                d.item_id,
                SUM(d.quantity) AS total_received
            FROM 
                inventory_item_details d
                group by d.item_id
        ) rh ON i.id = rh.item_id
    LEFT JOIN 
        (
            -- Get total supplied quantity per item (remarks not null or not 'Not Supplied')
            SELECT 
                p.item_id,
                SUM(p.quantity) AS total_supplied
            FROM 
                sorder_parts p
            WHERE 
                p.remarks IS NOT NULL 
                AND p.remarks != 'Not Supplied'
            GROUP BY 
                p.item_id
        ) sh ON i.id = sh.item_id
) derived_table ON i.id = derived_table.item_id
SET 
    i.stock_quantity = derived_table.updated_stock_quantity;






/*UPDATE ITEMS BASED ON  PRODUCT HISTORY LOGIC */

-- 1. Get the total received quantity for the item per site
CREATE TEMPORARY TABLE temp_received AS
SELECT 
    d.item_id,
    SUM(d.quantity) AS total_received
FROM 
    inventory_item_details d
GROUP BY 
    d.item_id;

-- 2. Get the total supplied quantity for the item per site
CREATE TEMPORARY TABLE temp_supplied AS
SELECT 
    sp.item_id,
    SUM(sp.qty_supplied) AS total_supplied
FROM 
    sorder_parts sp, sorders s
WHERE  s.id = sp.sorder_id and 
    s.status IN ('Supplied', 'Partially Supplied')
GROUP BY 
    sp.item_id;

-- 3. Update the stock_quantity in the items table
UPDATE items i
JOIN temp_received r ON i.id = r.item_id
LEFT JOIN temp_supplied s ON r.item_id = s.item_id
SET 
    i.stock_quantity = COALESCE(r.total_received, 0) - COALESCE(s.total_supplied, 0);

-- 4. Drop the temporary tables after update (optional)
DROP TEMPORARY TABLE IF EXISTS temp_received;
DROP TEMPORARY TABLE IF EXISTS temp_supplied;